<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Times New Roman', Times, serif;
      margin: 0;
      overflow: auto;
    }
    #background {
      font-family: 'Times New Roman', Times, serif;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color:#800000;
      z-index: -1;
    }
    .questionnaire-container {
      font-family: 'Times New Roman', Times, serif;
      display: none;
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      padding: 20px;
      background-color: white;
      z-index: 1;
      }
      .redText {
        color: red
      }
      .blackText {
        color: black
      }
      h1{
        font-family: 'Times New Roman', Times, serif;
        text-decoration: underline;
        text-align: center;
      }
      text{
        font-family: 'Times New Roman', Times, serif;
        color: red;
      }
  </style>

</head>
<body onload="initialize()">
  <div id="background"></div>
  <div id="questionnaireContainer" class="questionnaire-container">
  </div>

  <script>
        // JavaScript code to check the user number and redirect if it's missing
        document.addEventListener('DOMContentLoaded', function() {
        // Retrieve the user number from sessionStorage
        var userNumber = sessionStorage.getItem('userId');

        // Check if the user number is not found
        if (!userNumber) {
            // Redirect to the 'enter_user_number.html' page
            window.location.href = 'enter_user_number.html';
        }
    });

    sessionStorage.setItem('userType', 'expert');
    sessionStorage.setItem('experimentSource', 'na');
    sessionStorage.setItem('experimentType', 'audio');


    // This block of code displays the preaching experience form to the user
    // ----------------------------------------------------------------------
    // ----------------------------------------------------------------------
    // ----------------------------------------------------------------------

    // displays the questionnaire to the user
    function showQuestionnaire() {
      const questionnaireContainer = document.getElementById('questionnaireContainer');
      questionnaireContainer.innerHTML = generateQuestionnaireHTML();

      // Display the questionnaire
      questionnaireContainer.style.display = 'block';
    }

    // generates the questionnaire
    function generateQuestionnaireHTML() {
      // You can customize the questionnaire HTML generation based on your requirements
      return `
        <h1>Preaching Experience</h1>

        <h1>Instructions </h1>
        <p> These questions are about your experience as a preacher.
          You are required to respond to all of the required questions before submitting the form.
          Any unrequired question will be tagged as "optional".
          </p>
        
        <h1> Questions </h1>

        <!-- Preaching Duration -->

        <label for = "preaching_duration">
        <p>How many years have you been preaching?</p>
        </label>
        <label>
          <input type="checkbox" name="preaching_duration" value="Less than 1 year" onclick="uncheckOthers('preaching_duration', this)"> Less than 1 year
        </label> <br>
        <label>
          <input type="checkbox" name="preaching_duration" value="1 - 5 years" onclick="uncheckOthers('preaching_duration', this)"> 1 - 5 years
        </label> <br>
        <label>
          <input type="checkbox" name= "preaching_duration" value="6 - 10 years" onclick="uncheckOthers('preaching_duration', this)"> 6 - 10 years
        </label> <br>
        <label>
          <input type="checkbox" name="preaching_duration" value="11 - 15 years" onclick="uncheckOthers('preaching_duration', this)"> 11 - 15 years
        </label> <br>
        <label>
          <input type="checkbox" name="preaching_duration" value="16 - 20 years" onclick="uncheckOthers('preaching_duration', this)"> 16 - 20 years
        </label> <br>
        <label>
          <input type="checkbox" name="preaching_duration" value="More than 20 years" onclick="uncheckOthers('preaching_duration', this)"> More than 20 years
        </label> <br> <br>
        <label for="freeform">Additional Comments (optional):</label>
        <textarea id="PreachingDurationAdditionalComments" name="freeform" rows="4" cols="50"></textarea>
        <br> <br> <br> 


        <!-- Teaching Duration -->

        <label for = "teaching_duration">
        <p>How many years have you been teaching how to preach?</p>
        </label>
        <label>
          <input type="checkbox" name="teaching_duration" value="Less than 1 year" onclick="uncheckOthers('teaching_duration', this)"> Less than 1 year
        </label> <br>
        <label>
          <input type="checkbox" name="teaching_duration" value="1 - 5 years" onclick="uncheckOthers('teaching_duration', this)"> 1 - 5 years
        </label> <br>
        <label>
          <input type="checkbox" name= "teaching_duration" value="6 - 10 years" onclick="uncheckOthers('teaching_duration', this)"> 6 - 10 years
        </label> <br>
        <label>
          <input type="checkbox" name="teaching_duration" value="11 - 15 years" onclick="uncheckOthers('teaching_duration', this)"> 11 - 15 years
        </label> <br>
        <label>
          <input type="checkbox" name="teaching_duration" value="16 - 20 years" onclick="uncheckOthers('teaching_duration', this)"> 16 - 20 years
        </label> <br>
        <label>
          <input type="checkbox" name="teaching_duration" value="More than 20 years" onclick="uncheckOthers('teaching_duration', this)"> More than 20 years
        </label> <br> <br>
        <label for="freeform">Additional Comments (optional):</label>
        <textarea id="teachingDurationAdditionalComments" name="freeform" rows="4" cols="50"></textarea>
        <br> <br> <br>


        <!-- Preaching Regularity -->
        <label for = "preaching_regularity">
        <p>How often do you preach to a congregation?</p>
        </label>
        <label>
          <input type="checkbox" name="preaching_regularity" value="Once a day" onclick="uncheckOthers('preaching_regularity', this)"> Once a day
        </label>
        <br>
        <label>
          <input type="checkbox" name= "preaching_regularity" value="A few times a week" onclick="uncheckOthers('preaching_regularity', this)"> A few times a week
        </label>
        <br>
        <label>
          <input type="checkbox" name="preaching_regularity" value="Once a week" onclick="uncheckOthers('preaching_regularity', this)"> Once a week
        </label>
        <br>
        <label>
          <input type="checkbox" name="preaching_regularity" value="A few times a month" onclick="uncheckOthers('preaching_regularity', this)"> A few times a month
        </label>
        <br>
        <label>
          <input type="checkbox" name= "preaching_regularity" value="Once a month" onclick="uncheckOthers('preaching_regularity', this)"> Once a month
        </label>
        <br>
        <label>
          <input type="checkbox" name="preaching_regularity" value="A few times a year" onclick="uncheckOthers('preaching_regularity', this)"> A few times a year
        </label>
        <br>
        <label>
          <input type="checkbox" name= "preaching_regularity" value="Once a year" onclick="uncheckOthers('preaching_regularity', this)"> Once a year
        </label>
        <br>
        <label>
          <input type="checkbox" name="preaching_regularity" value="Seldom" onclick="uncheckOthers('preaching_regularity', this)"> Seldom
        </label>
        <br>
        <label>
          <input type="checkbox" name="preaching_regularity" value="Never" onclick="uncheckOthers('preaching_regularity', this)"> Never
        </label>
        <br> <br>
        <label for="freeform">Additional Comments (optional):</label>
        <textarea id="preachingRegularityAdditionalComments" name="freeform" rows="4" cols="50"></textarea>
        <br> <br> <br>


        </label> <br>
        <label for="freeform">Other valuable information relating to your preaching/teaching experience (optional):</label> <br>
        <br>

        <textarea id="OtherValuableInfo" name="freeform" rows="4" cols="50"></textarea>

        <br> <br>
        <center>
          <text id = 'errorMessage'> </text>
        </center>
        

        <!-- Submit button -->
        <br>
        <br>
        <center>
          <button onclick="submitForm()">Submit</button>
        </center>
        <br>
      `;
    }

    // ----------------------------------------------------------------------
    // ----------------------------------------------------------------------
    // ----------------------------------------------------------------------


    // If the form is completed this block of code submits the questionnaire, 
    // sends results to the server, and navigates the user to the exit screen.
    // Otherwise, an error message is displayed.
    // ----------------------------------------------------------------------
    // ----------------------------------------------------------------------
    // ----------------------------------------------------------------------

    async function initialize() {

      // recover info about user data
      const userId = sessionStorage.getItem('userId');
      const userType = sessionStorage.getItem('userType');
      const experimentSource = sessionStorage.getItem('experimentSource');
      const experimentType = sessionStorage.getItem('experimentType');

      // checks if the consent form has been completed first
      const consentCompleted = await checkCompleted(userId, userType, experimentSource, experimentType, 'consentInfo.csv');

      // delay to fix some local testing wackiness
      await new Promise(resolve => setTimeout(resolve, 10));

      // if the user has not completed their homilies, then send them to another homily
      if (!consentCompleted) {
        window.location.href = 'consentScreen.html';
      } 
      else {

        // check if the user has completed all of the homilies/associated questionnaires
        const homiliesCompleted = await checkHomiliesCompleted(userId, userType, experimentSource, experimentType);

        // delay to fix some local testing wackiness
        await new Promise(resolve => setTimeout(resolve, 10));

        // if the user has not completed their homilies, then send them to another homily
        if (!homiliesCompleted) {
          window.location.href = 'new_homily_wait_screen.html';
        } 
        else {
          showQuestionnaire();
        }
      }
    }

    // If completed, data is sent to server and user is redirected to exit screen
    async function submitForm() {
        const isValid = await validateForm();
        if (!isValid) {
          const errorMessage = document.getElementById('errorMessage');
          errorMessage.textContent = 'You must respond to all required questions before submitting';
          setTimeout(function() {
            errorMessage.textContent = '';
          }, 3000);
        }
        else {
            header = await getHeader();
            data = await getData();
            await sendResults(header, data);
            window.location.href = 'userDemographics.html';
        }
      }


    // ensures that the user responds to all required questions
    // helper for "submitForm()"
    async function validateForm() {

      // collect all response checkboxes from the form
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');

      // variable to keep track of valid responses
      // (set to false if invalid response found)
      var valid = true;

      // variables for coloring unanswered questions in red
      var answered = [];
      var unanswered = [];

      // lets us group checkboxes by question
      var name_dict = {};

      // collect all checkboxes of a given name into a list
      for (let checkbox of checkboxes){

        // collect the question name for the checkbox
        const name = checkbox.name;

        // add the checkbox to its proper list in the JS object
        try {
          name_dict[name].push(checkbox);
        } 
        catch (error){
          name_dict[name] = [checkbox];
        }
      }
        
      for (const [name, questionCheckboxes] of Object.entries(name_dict)) {

        // variable to keep track of if a user responded to the question
        // (i.e. at least one checkbox is checked)
        let responded = false;

        // iterate over the checkboxes in the question
        for (let checkbox of questionCheckboxes){

          // if a checkbox is checked, set responded to true
          // and add the question name to list of answered questions
          if (checkbox.checked) {
            responded = true;
            answered.push(name);
          }
        }

        // if the user did not check a checkbox, then add to list of unanswered questions
        // and set the valid variable to false
        if (!responded) {
            unanswered.push(name);
            valid = false;
          } 
      }
      
      // highlight unanswered questions red and color answered questions black
      await colorAnsweredAndUnanswered(answered, unanswered);
      
      return valid;
    }

    // highlights unanswered questions in red and answered questions in black
    async function colorAnsweredAndUnanswered(answered, unanswered) {
      
      // color all of the unanswered questions in red
      for (let unansweredQuestion of unanswered) {
        let checkboxes = document.querySelectorAll(`input[type="checkbox"][name="${unansweredQuestion}"]`);
        let questionText = document.querySelector(`label[for="${unansweredQuestion}"]`).querySelector('p');
        questionText.classList.remove('blackText');
        questionText.classList.add('redText');
        for (let checkbox of checkboxes) {
          checkbox.closest('label').classList.remove('blackText');
          checkbox.closest('label').classList.add('redText');
        }
      }

      // color all of the answered questions in black
      for (let answeredQuestion of answered) {
        let checkboxes = document.querySelectorAll(`input[type="checkbox"][name="${answeredQuestion}"]`);
        let questionText = document.querySelector(`label[for="${answeredQuestion}"]`).querySelector('p');
        questionText.classList.remove('redText');
        questionText.classList.add('blackText');
        for (let checkbox of checkboxes) {
          checkbox.closest('label').classList.remove('redText');
          checkbox.closest('label').classList.add('blackText');
        }
      }
    }

    
    // sends the user response to the server to be stored as a csv
    async function sendResults(header, data) {

      // collect user info
      const userId = sessionStorage.getItem('userId');
      const userType = sessionStorage.getItem('userType');
      const experimentSource = sessionStorage.getItem('experimentSource');
      const experimentType = sessionStorage.getItem('experimentType');
      const fileName = 'preachingExperience.csv';

      // url for route that stores the religious demographic
      const url = `/api/storeResponses`;

      // package the results in an Object to later stringify
      var results = {}
      for (let i = 0; i < header.length; i++){
        results[String(header[i])] = String(data[i]);
      }

      
      // try sending sign in data to server, keep trying until we get an "ok" response (response code in the 200s range)
      const maxRetries = 3;
      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        
        try {
          // AJAX request to the server to store consent info
          const response = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type' : 'application/json'},
          body: JSON.stringify({
                'userId' : userId, 
                'userType' : userType,
                'experimentSource' : experimentSource,
                'experimentType' : experimentType,
                'fileName' : fileName,
                'results' : JSON.stringify(results)})
          });

          // If the response was "ok" then return the server's response
          if (response.ok) {
            return await response.json();
          } 
          // otherwise we log the error (visible under inspect element)
          else {
            console.error(`Attempt ${attempt} at saving religious demographic data: Server responded with status ${response.status}`);
          }
         }
         // if the code fails due to some error, then...
         catch (error) {
           console.error(`Attempt ${attempt}: Failed to fetch from ${url} with error ${error}`);
         }
      }
      // final error thrown after we have exhausted the maximum number of retries
      throw new Error(`Failed to save religious demographic data after ${maxRetries} attempts`);
    } 

    // checks if user demographic or religious demographic have been completed
    async function checkCompleted(userId, userType, experimentSource, experimentType, fileName) {
        
        // url for route that will check for the existence of the given file name
        const url = `/api/CheckFileOrFolderExists/${userId}/${userType}/${experimentSource}/${experimentType}/${fileName}`;

        // maximum number of times we will try to contact the server
        const maxRetries = 3; 
        for (let attempt = 1; attempt <= maxRetries; attempt ++) {

          // try contacting the server for info about user completion of homilies
          try {
          
            // get the server's response to our request
            const response = await fetch(url);
            
            // if the server's response is OK (200s range), then...
            if (response.ok) {

              // parse the response and extract the data regarding homily completion
              const parsedResponse = await response.json();
              const completed = await parsedResponse.fileExists;

              // return this information
              return completed;
            }
            // if the server's response is not ok, then log the error to the console
            else {
              console.error(`Attempt ${attempt} at logging user sign in times: Server responded with status ${response.status}`);
            }
          }
          // if the code fails due to some error, then...
          catch (error) {
              console.error(`Attempt ${attempt}: Failed to fetch from ${url} with error ${error}`);
          }
        }
        // final error thrown after we have exhausted the maximum number of retries
        throw new Error(`Failed to recover user's homily completion status after ${maxRetries} attempts`);
      }

    // checks if the the user has viewed all of the homilies for proper redirection
    async function checkHomiliesCompleted(userId, userType, experimentSource, experimentType) {
      
      // url for route that checks if all homilies have been completed
      const url = `/api/allHomiliesViewed/${userId}/${userType}/${experimentSource}/${experimentType}`;

      // maximum number of times we will try to contact the server
      const maxRetries = 3; 
      for (let attempt = 1; attempt <= maxRetries; attempt ++) {

        // try contacting the server for info about user completion of homilies
        try {
        
          // get the server's response to our request
          const response = await fetch(url);
          
          // if the server's response is OK (200s range), then...
          if (response.ok) {

            // parse the response and extract the data regarding homily completion
            const parsedResponse = await response.json();
            const homiliesCompleted = await parsedResponse.allHomiliesCompleted;

            // return this information
            return homiliesCompleted;
          }
          // if the server's response is not ok, then log the error to the console
          else {
            console.error(`Attempt ${attempt} at checking if user has completed all homilies: Server responded with status ${response.status}`);
          }
        }
        // if the code fails due to some error, then...
        catch (error) {
            console.error(`Attempt ${attempt}: Failed to fetch from ${url} with error ${error}`);
        }
      }
      // final error thrown after we have exhausted the maximum number of retries
      throw new Error(`Failed to recover user's homily completion status after ${maxRetries} attempts`);
    }


    // retrieves the header for the soon-to-be csv file
    // helper for "submitForm()"
    async function getHeader() {
      let checkboxNames = [];
      let textboxNames = [];
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      const textboxes = document.querySelectorAll('textarea');

      // collect all check box names in order
      for (let checkbox of checkboxes) {
        const name = checkbox.name;
        if (!checkboxNames.includes(name)) {
          checkboxNames.push(name);
        }
      }

      // collect all textbox names
      for (let textbox of textboxes) {
        const name = textbox.id;
        textboxNames.push(name);}

      return checkboxNames.concat(textboxNames);
    }


    // retrieves the header for the soon-to-be csv file
    // helper for "submitForm()"
    async function getData() {
      let name_dict = {};
      let checkboxData = [];
      let textboxData = [];
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      const textboxes = document.querySelectorAll('textarea');

      // collect all checkboxes of a given name into a list
      for (let checkbox of checkboxes){
        const name = checkbox.name;
        try {
          name_dict[name].push(checkbox);
        } catch (error){
          name_dict[name] = [checkbox];
        }}
            
      // iterate over all checkbox questions
      for (const [name, questionCheckboxes] of Object.entries(name_dict)) {

        // iterate over each checkbox in a given question
        for (let checkbox of questionCheckboxes) {

          // add all values of checked checkboxes to the list
          if (checkbox.checked) {
            checkboxData.push(String(checkbox.value));
          }
        }
      }

      // iterate over all textbox questions
      for (let textbox of textboxes) {
        let textEntry = textbox.value;
        textboxData.push(textEntry);
      }

      return checkboxData.concat(textboxData);}

    // ----------------------------------------------------------------------
    // ----------------------------------------------------------------------
    // ----------------------------------------------------------------------


    // ensures that at most one checkbox is selected at a time for each question
    function uncheckOthers(groupName, currentCheckbox) {
      const checkboxes = document.querySelectorAll(`input[name="${groupName}"]`);
      checkboxes.forEach(checkbox => {
      if (checkbox !== currentCheckbox) {
        checkbox.checked = false;}})
    };
    

  </script>
</body>
</html>