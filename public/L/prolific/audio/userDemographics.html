<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Homily Review</title>
  <style>
    body {
      font-family: 'Times New Roman', Times, serif;
      margin: 0;
      overflow: auto;
    }
    #background {
      font-family: 'Times New Roman', Times, serif;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color:#800000;
      z-index: -1;
    }
    .questionnaire-container {
      font-family: 'Times New Roman', Times, serif;
      display: none;
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      padding: 20px;
      background-color: white;
      z-index: 1;
      }
      .redText {
        color: red
      }
      .blackText {
        color: black
      }
      h1{
        font-family: 'Times New Roman', Times, serif;
        text-align: center;
        text-decoration: underline;
      }
      button{
        font-family: 'Times New Roman', Times, serif;
        justify-content: center;
      }
      text{
        font-family: 'Times New Roman', Times, serif;
        color: red;
      }
  </style>
</head>
<body onload="showQuestionnaire()">
  <div id="background"></div>
  <div id="questionnaireContainer" class="questionnaire-container">
  </div>

  <script>

    // JavaScript code to check the user number and redirect if it's missing
    document.addEventListener('DOMContentLoaded', function() {
        // Retrieve the user number from sessionStorage
        var userNumber = sessionStorage.getItem('userId');

        // Check if the user number is not found
        if (!userNumber) {
            // Redirect to the 'enter_user_number.html' page
            window.location.href = 'enter_user_number.html';
        }
    });
    sessionStorage.setItem('userType', 'laymen');
    sessionStorage.setItem('experimentSource', 'prolific');
    sessionStorage.setItem('experimentType', 'audio');

    // this block of code creates and displays the questionnaire
    // -----------------------------------------------------------------------------
    // -----------------------------------------------------------------------------
    // -----------------------------------------------------------------------------

    function showQuestionnaire() {
      const questionnaireContainer = document.getElementById('questionnaireContainer');
      questionnaireContainer.innerHTML = generateQuestionnaireHTML();

      // Display the questionnaire
      questionnaireContainer.style.display = 'block';
    }


    function generateQuestionnaireHTML() {
      // You can customize the questionnaire HTML generation based on your requirements
      return `
        
        <h1> Demographic Survey </h1>

        <h1>Instructions </h1>
        <p>Please respond to the following questions about your background.
          You must respond to all of the required questions before submitting the form.
          Any unrequired question will be tagged as "optional".
        </p>

        <!-- Age -->
        <label for="age"><p>1. Age:</p></label>
        <input type="number" id="age" name = "age" placeholder="Enter your age"> 
        <br><br><br>

        <!-- Gender -->
        <label for = "gender">
        <p>2. What is your gender?</p>
        </label>
        <label>
          <input type="checkbox" name="gender" value="Male" onclick="uncheckOthers('gender', this)"> Male
        </label>
        <br>
        <label>
          <input type="checkbox" name="gender" value="Female" onclick="uncheckOthers('gender', this)"> Female
        </label>
        <br>
        <label>
          <input type="checkbox" name="gender" value="Prefer not to answer or prefer to self-describe" onclick="uncheckOthers('gender', this)"> Prefer not to answer or prefer to self-describe
        </label>
        <label for="selfDescribeGender"><p>Prefer to self-describe:</p></label>
        <input type="text" name = "selfDescribeGender" id="selfDescribeGender"> 
        <br> <br> <br>


        <!-- Racial/Ethnic Identity-->
        <label for = "ethnicity">
        <p>3. Which of the following describes your ethnic and/or racial identity?</p>
        </label>
        <label>
            <input type="checkbox" name="ethnicity" value="Hispanic or Latino" onclick="uncheckOthers('ethnicity', this)"> Hispanic or Latino
        </label>
        <br>
        <label>
            <input type="checkbox" name="ethnicity" value="Black or African American" onclick="uncheckOthers('ethnicity', this)"> Black or African American
        </label>
        <br>
        <label>
          <input type="checkbox" name="ethnicity" value="White" onclick="uncheckOthers('ethnicity', this)"> White
        </label>
        <br>
        <label>
          <input type="checkbox" name= "ethnicity" value="Asian" onclick="uncheckOthers('ethnicity', this)"> Asian
        </label>
        <br>
        <label>
          <input type="checkbox" name="ethnicity" value="American Indian or Alaskan Native" onclick="uncheckOthers('ethnicity', this)"> American Indian or Alaskan Native
        </label>
        <br>
        <label>
          <input type="checkbox" name="ethnicity" value="Native Hawaiian or Pacific Islander" onclick="uncheckOthers('ethnicity', this)"> Native Hawaiian or Pacific Islander
        </label>
        <br>
        <label>
        <input type="checkbox" name= "ethnicity" value="Two or more" onclick="uncheckOthers('ethnicity', this)"> Two or more
        </label>
        <br>
        <label>
          <input type="checkbox" name="ethnicity" value="Prefer not to answer or prefer to self-describe" onclick="uncheckOthers('ethnicity', this)"> Prefer not to answer or prefer to self-describe
        </label>
        <label for="selfDescribeEthnicity"><p>Two or more or prefer to self-describe:</p></label>
        <input type="text" name = "selfDescribeEthnicity" id="selfDescribeEthnicity"> 
        <br> <br> <br>


        <!-- Economic Class-->
        <label for = "economicClass">
        <p>4. Do you consider yourself to come from a:</p>
        </label>
        <label>
            <input type="checkbox" name="economicClass" value="Low income background" onclick="uncheckOthers('economicClass', this)"> Low income background
        </label>
        <br>
        <label>
          <input type="checkbox" name="economicClass" value="Lower-middle income background" onclick="uncheckOthers('economicClass', this)"> Lower-middle income background
        </label>
        <br>
        <label>
          <input type="checkbox" name= "economicClass" value="Middle income background" onclick="uncheckOthers('economicClass', this)"> Middle income background
        </label>
        <br>
        <label>
          <input type="checkbox" name="economicClass" value="Upper-middle income background" onclick="uncheckOthers('economicClass', this)"> Upper-middle income background
        </label>
        <br>
        <label>
          <input type="checkbox" name="economicClass" value="High income background" onclick="uncheckOthers('economicClass', this)"> High income background
        </label>
        <br><br><br>


        <!-- Country of Origin -->
        <label for = "countryOfOrigin">
        <p>5. What is your country of origin?</p>
        </label>
        <input type="text" name = "countryOfOrigin" id="countryOfOrigin"> 
        <br><br><br>


        <!-- US residence duration -->
        <label for="USAResidenceDuration"><p>6. If you currently live in the United States, how many years have you lived in the US? </p></label>
        <input type="number" id="USAResidenceDuration" name = "USAResidenceDuration" placeholder="Number of years"> 
        <br> <br> <br>


        <!-- English first language-->
        <label for = "englishFirstLanguage">
        <p>7. Is English your first language? </p>
        </label>
        <label>
            <input type="checkbox" name="englishFirstLanguage" value="Yes" onclick="uncheckOthers('englishFirstLanguage', this)"> Yes
        </label>
        <br>
        <label>
          <input type="checkbox" name="englishFirstLanguage" value="No" onclick="uncheckOthers('englishFirstLanguage', this)"> No
        </label>
        <br><br>

        <label for="otherLanguages"><p>8. Please list any other languages, if any, that you speak fluently:</p></label>
        <br>
        <textarea id="otherLanguages" name="otherLanguages" rows="4" cols="50"></textarea>
        <br><br><br>

        
        <!-- Submit button -->
        <br> <br>
        <center>
          <text id = 'errorMessage'> </text>
        </center>
        <br>
        <center>
          <button onclick="submitForm()">Submit</button>
        </center>
        <br>
      `;
    }

    // -----------------------------------------------------------------------------
    // -----------------------------------------------------------------------------
    // -----------------------------------------------------------------------------



    // this block of code checks if user has completed the form and if so,
    // sends that data to the server to be stored as a csv file. 
    // If not, an error message is displayed.
    // ---------------------------------------------------------------------
    // ---------------------------------------------------------------------
    // ---------------------------------------------------------------------

    // submits the form and send data if complete, otherwise gives error message
    function submitForm() {
      const isValid = validateForm();
      if (!isValid) { // if response is not valid (missing responses etc...)
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.textContent = 'You must respond to all questions';
        setTimeout(function() {
          errorMessage.textContent = '';
        }, 3000);
      }
      else{ // if responses are valid

          // get header and data and store as csv
          header = getHeader();
          data = getData();
          console.log(sendResults(header, data));
          window.location.href = 'debrief.html';
          }
      }


    // returns the word count of a string
    // (helper for validate form)
    function wordCount(string){
      const words = string.split(" ");
      wordcount = 0;
      for (let i = 0; i < words.length; i++){
        if (!words[i] == ' ') {
          wordcount += 1;
        }
      }
      return wordcount;
    }
    
    // validates that the user answered all questions
    // (helper for submit form)
    function validateForm() {
      const checkboxes = document.querySelectorAll(`input[type="checkbox"]`);
      const textboxes = document.querySelectorAll(`input[type="text"]`);
      const numberBoxes = document.querySelectorAll(`input[type="number"]`);
      
      let valid = true;
      var answered = [];
      var unanswered = [];
      let checkbox_name_dict = {};
      let textbox_name_dict = {};



      // collect all names of checkboxes
      for (let i = 0; i < checkboxes.length; i++){
        name = checkboxes[i].name;
        //console.log(name);
        try {
          checkbox_name_dict[name].push(checkboxes[i]);
        } catch (error){
          checkbox_name_dict[name] = [checkboxes[i]];
        }}

      // collect all names of textboxes
      for (let i = 0; i < textboxes.length; i++){
        name = textboxes[i].name;
        try {
          textbox_name_dict[name].push(textboxes[i]);
        } catch (error){
          textbox_name_dict[name] = [textboxes[i]];
        }}
      
      // check that each checkbox has a response
      for (const [key, value] of Object.entries(checkbox_name_dict)){
        //console.log(key);
        let responded = false;
        for (let i = 0; i < value.length; i++){
          if (value[i].checked){
            responded = true;}}

          if (!responded){
            if (!unanswered.includes(key)) {
              //console.log(key);
              unanswered.push(key);
            }
            valid = false;
          } else {
            if (!answered.includes(key)){
              //console.log(key);
            answered.push(key);
            }
          }
        }

    // make sure each numberbox has a response
    for (let i = 0; i < numberBoxes.length; i++){
      let response = numberBoxes[i].value;
      console.log(response);

      if (response.length == 0){
        if (!unanswered.includes(numberBoxes[i].name)) {
              //console.log(key);
              unanswered.push(numberBoxes[i].name);
      }
      valid = false;
    } else {
          if (!answered.includes(numberBoxes[i].name)){
              //console.log(key);
            answered.push(numberBoxes[i].name);
          }
            }
      }
    
    let countryOfOriginTextBox = document.querySelector(`input[type="text"][name="countryOfOrigin"]`).value;
    //console.log(countryOfOriginTextBox);
    if (wordCount(countryOfOriginTextBox) == 0){
      valid = false;
      unanswered.push('countryOfOrigin');
    } else {
      answered.push('countryOfOrigin');
    }

    let ethnicityCheckboxes = document.getElementsByName('ethnicity');
    
    // If user answers with two or more, make sure they self describe
    for (let i = 0; i < ethnicityCheckboxes.length; i++){
      let response = ethnicityCheckboxes[i].value;
      if (ethnicityCheckboxes[i].checked && response == 'Two or more'){
        for (let j = 0; j < textboxes.length; j++) {
          textResponse = textboxes[j].value;
          name = textboxes[j].name
          if (name == 'selfDescribeEthnicity' && wordCount(textResponse) == 0){
            console.log('here');
            if (!unanswered.includes('ethnicity')){
              unanswered.push('ethnicity');
            }
            answered = answered.filter(item => item !== 'ethnicity');
            console.log('new answered: ', answered);
            //console.log(unanswered);
            valid = false;
          }
        }
      }
    }

    console.log('unanswered: ', unanswered)
    console.log('answered: ', answered)
    console.log('valid: ', valid);
    colorAnsweredAndUnanswered(answered, unanswered);
    return valid;
  }

    // highlights unanswered questions in red and answered questions in black
    function colorAnsweredAndUnanswered(answered, unanswered) {
      //console.log('here');
      // color all of the unanswered questions in red
      for (let i = 0; i < unanswered.length; i++) {
        //console.log(unanswered[i])
        // handle country of origin, age and USA residence duration
        if (unanswered[i] == 'countryOfOrigin' || unanswered[i] == 'age' || unanswered[i] == 'USAResidenceDuration') {
          let questionText = document.querySelector(`label[for="${unanswered[i]}"]`).querySelector('p');
          questionText.classList.remove('blackText');
          questionText.classList.add('redText');
          continue;
        } 

        // handle ethnicity questions
        if (unanswered[i] == 'ethnicity') {
          // handle ethnicity textbox
          let questionText = document.querySelector(`label[for="selfDescribeEthnicity"]`).querySelector('p');
          questionText.classList.remove('blackText');
          questionText.classList.add('redText');
        } 

        // handle gender questions
        if (unanswered[i] == 'gender') {
          // handle gender textbox
          let questionText = document.querySelector(`label[for="selfDescribeGender"]`).querySelector('p');
          questionText.classList.remove('blackText');
          questionText.classList.add('redText');
        } 
        
        //console.log(unanswered[i])
        let checkboxes = document.querySelectorAll(`input[type="checkbox"][name="${unanswered[i]}"]`);
        let questionText = document.querySelector(`label[for="${unanswered[i]}"]`).querySelector('p');
        questionText.classList.remove('blackText');
        questionText.classList.add('redText');
        for (j = 0; j < checkboxes.length; j++ ) {
          checkboxes[j].closest('label').classList.remove('blackText');
          checkboxes[j].closest('label').classList.add('redText');
        }
      }

      // color all of the answered questions in black
      //console.log(answered.length)
      // color all of the unanswered questions in red
      for (let i = 0; i < answered.length; i++) {

        // handle country of origin, age and USA residence duration
        if (answered[i] == 'countryOfOrigin' || answered[i] == 'age' || answered[i] == 'USAResidenceDuration') {
          let questionText = document.querySelector(`label[for="${answered[i]}"]`).querySelector('p');
          questionText.classList.remove('redText');
          questionText.classList.add('blackText');
          continue;
        } 

        // handle ethnicity questions
        if (answered[i] == 'ethnicity') {
          // handle ethnicity textbox
          let questionText = document.querySelector(`label[for="selfDescribeEthnicity"]`).querySelector('p');
          questionText.classList.remove('redText');
          questionText.classList.add('blackText');
        } 

        // handle gender questions
        if (answered[i] == 'gender') {
          // handle gender textbox
          let questionText = document.querySelector(`label[for="selfDescribeGender"]`).querySelector('p');
          questionText.classList.remove('redText');
          questionText.classList.add('blackText');
        } 
        
        //console.log(answered[i])
        let checkboxes = document.querySelectorAll(`input[type="checkbox"][name="${answered[i]}"]`);
        let questionText = document.querySelector(`label[for="${answered[i]}"]`).querySelector('p');
        questionText.classList.remove('redText');
        questionText.classList.add('blackText');
        for (j = 0; j < checkboxes.length; j++ ) {
          checkboxes[j].closest('label').classList.remove('redText');
          checkboxes[j].closest('label').classList.add('blackText');
        }
      }
    }
    
    // sends the user response to the server to be stored as a csv
    // (helper for submit form)
    async function sendResults(header, data){
      const userId = sessionStorage.getItem('userId');
      const userType = sessionStorage.getItem('userType');
      const homilyId = sessionStorage.getItem('homilyId');
      const experimentSource = sessionStorage.getItem('experimentSource');
      const experimentType = sessionStorage.getItem('experimentType');
      const url = `/api/storeUserDemographicResults`;

      // package the results in an Object to later stringify
      let results = {}
      for (let i = 0; i < header.length; i++){
        results[String(header[i])] = String(data[i]);
      }

      //console.log('here');
      const response = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type' : 'application/json'},
        body: JSON.stringify({
              'userId' : userId, 
              'userType' : userType,
              'homilyId' : homilyId,
              'experimentSource' : experimentSource,
              'experimentType' : experimentType,
              'results' : JSON.stringify(results)})
        });
        return await response.json();
      } 


    // gets the header for the soon-to-be csv file on the server
    // (helper for "submitForm())
    function getHeader(){

      // variables for storing names of variables and their responses to such variables
      let checkboxNames = [];
      let textboxNames = [];
      let bigTextboxNames = []
      let numberboxNames = [];
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      const textboxes = document.querySelectorAll('input[type="text"]');
      const numberboxes = document.querySelectorAll('input[type="number"]');
      const bigTextboxes = document.querySelectorAll('textarea');

      // collect all check box names in order
      for (let i = 0; i < checkboxes.length; i++){
        let name = checkboxes[i].name;
        if (!checkboxNames.includes(name)){
          checkboxNames.push(name);
        }
      }

      // collect all textbox names
      for (let i = 0; i < textboxes.length; i++){
        let name = textboxes[i].id;
        textboxNames.push(name);
      }

      // collect all numberbox names
      for (let i = 0; i < numberboxes.length; i++){
        let name = numberboxes[i].id;
        numberboxNames.push(name);
      }

      // collect all big textbox names
      for (let i = 0; i < bigTextboxes.length; i++){
        let name = bigTextboxes[i].id;
        bigTextboxNames.push(name);
      }

      return checkboxNames.concat(textboxNames, numberboxNames, bigTextboxNames);
    }

    
    // gets the data for the soon-to-be csv file on the server
    // (helper for "submitForm())
    function getData(){
      // places to store names and data
      let name_dict = {};
      let checkboxData = [];
      let textboxData = [];
      let numberboxData = [];
      let bigTextboxData = [];

      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      const textboxes = document.querySelectorAll('input[type="text"]');
      const numberboxes = document.querySelectorAll('input[type="number"]');
      const bigTextboxes = document.querySelectorAll('textarea');

      // collect all checkboxes of a given name into a list
      for (let i = 0; i < checkboxes.length; i++){
        name = checkboxes[i].name;
        try {
          name_dict[name].push(checkboxes[i]);
          } catch (error){
            name_dict[name] = [checkboxes[i]];}}
            
      // iterate over all checkbox questions
      for (const [key, value] of Object.entries(name_dict)){
        // iterate over each checkbox in a given question
        for (let i = 0; i < value.length; i++){
          let option = value[i];
          // add all values of checked checkboxes to the list
          if (option.checked){
            checkboxData.push(String(option.value));}}}

      // iterate over all textbox questions
        for (let i = 0; i < textboxes.length; i++){
          let textEntry = textboxes[i].value;
          textboxData.push(textEntry);}

      // iterate over all numberbox questions
      for (let i = 0; i < numberboxes.length; i++){
          let textEntry = numberboxes[i].value;
          numberboxData.push(textEntry);}

      // iterate over all textbox questions
      for (let i = 0; i < bigTextboxes.length; i++){
          let textEntry = bigTextboxes[i].value;
          bigTextboxData.push(textEntry);}

      return checkboxData.concat(textboxData, numberboxData, bigTextboxData); 
    }

    // ---------------------------------------------------------------------
    // ---------------------------------------------------------------------
    // ---------------------------------------------------------------------


    
    // ensures that the user has at most one checkbox selected at a time
    function uncheckOthers(groupName, currentCheckbox) {
      const checkboxes = document.querySelectorAll(`input[name="${groupName}"]`);
      checkboxes.forEach(checkbox => {
        if (checkbox !== currentCheckbox) {
          checkbox.checked = false;
        }})};


    // prevents the user from navigating backwards through the experiment
    history.pushState(null, document.title, location.href);
    window.addEventListener('popstate', function (event) {
      history.pushState(null, document.title, location.href);});
  </script>
</body>
</html>